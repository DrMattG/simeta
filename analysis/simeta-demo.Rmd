---
title: "the motivating use-case for simeta::"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
params: 
  trials: 3
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  cache = TRUE
  )

```


### Important message for future Charles: 

**Remember, writing this provides a fun and aesthestic way of debugging this algorithm. Focus on writing a cohesive document, and the debugging  will be enjoyable. It's a cognitive bait and switch; and it works. Make the document _pretty_, and you not be able to help ensuring the science is correct, because you hate doing a sloppy job at anything. Answer the question, with clarity and aesthetics; the motivation for correct science will follow.**

## preamble

```{r setup}
library(simeta)

# other packages used in this vignette
library(tidyverse)
library(skimr)

# otherwise i'll forget
conflicted::conflict_prefer("filter", winner = "dplyr")

# for reproducibility
set.seed(39)

```

# objective of the `simeta::` package

The `simeta::` package aims to provide coverage probability simulation results for estimators derived, as is common in meta-analyses, from summary statistics for the variance of the sample median. Different simulation-level parameters of interest can be specified so that simulated data mimics different meta-analytic conditions:

- Different numbers of $K$ studies.
- Different values of $\tau^2$, the variation between the studies.
- Different distributions.
- Different distributions of expected sample sizes.
- Different proportions of control and intervention group.

The components of the algorithm have been produced in a compartmentalised way, with the objective of exploring the extendability of this package to estimators for the variance of the sample mean, but also for estimators for the mean or median, themselves.   

In this vignette, we restrict ourselves to the original use-case of the package, testing estimators for the variance of the sample median.

# using `simeta::` to assess an estimator for the sample median

In this analysis, we are interested in assessing how an estimator for the variance of the sample median performs in under various meta-analytic conditions.

We will test estimators in the `varameta::` package. 

For example, given a sample median of 50, an interquartile range of 0.6, and a sample size of 24, what do we estimator the variance of the sample median to be? 

```{r median var}

varameta::effect_se(
  centre = 50, 
  spread = 0.6, 
  n = 24, 
  centre_type = "median",
  spread_type = "iqr") 

```

How can we tell if this is a *good* estimator for the variance of the sample median?

Well, if have the true median $\nu$ and the true distribution $f$, we can approximate the variance of the sample median thus,
$$
\textrm{var}(M) \approx \frac 1 {4nf(\nu)^2}.
$$





```{r metasims defaults}

# metasims function with default arguments
sims <-
  metasims(
    single_study = FALSE,
    measure = "median",
    measure_spread = "iqr",
    distributions = default_parameters,
    k = c(3, 7, 10),
    tau_sq_true = seq(from = 0, to = 0.4, by = 0.2),
    unequal_effect_ratio = 1.2,
    min_n = 20,
    max_n = 200,
    prop = 0.5,
    prop_error = 0.1,
    trials = params$trials,
    trial_fn = metatrial,
    beep = FALSE,
    knha = TRUE,
    progress = FALSE
  ) 

# take a look at results
sims %>% pluck("results") %>% head()

```

```{r coverage plot, out.width="\\textwidth"}
 
# basic scatterplot
sims %>% 
  coverage_plot()

```

# components of simeta


## simulation-level parameters

The `metasims` function has `default_parmeters`. But these can be modified.

```{r metasims args}
args(metasims)

```


It is expected to be of the form of a `tibble` with a column, `dist`, for R-friendly distribution names and a column, `par`. R-friendly means by concatenating on `d`, `p`, `q`, or `r`, you obtain a distribution function in R. 

```{r default parameters}
default_parameters %>% 
  kableExtra::kable() %>% 
  kableExtra::kable_styling()

```

The `simeta::` package is currently coded to simulate date from the normal, exponential, Pareto, and log-normal distributions. 

The mathematical methodology to is repeated, but the derivation is slightly different for each distribution, and a solution for generalising has not been developed yet.

For these distributions, any reasonable parameter choice can be specified via the `par` column. 



